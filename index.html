<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolfpack - Lake Champlain Ice Fishing</title>
    <style>
        :root[data-theme="dark"] {
            --bg-gradient-1: #1a2332;
            --bg-gradient-2: #0d1117;
            --text-primary: #00ff00;
            --text-secondary: #88ff88;
            --text-muted: #666;
            --border-primary: #00ff00;
            --border-secondary: #00aaff;
            --border-warning: #ffaa00;
            --panel-bg: rgba(0, 0, 0, 0.7);
            --panel-bg-alt: rgba(20, 20, 50, 0.9);
            --button-bg: #00ff00;
            --button-text: #000;
            --shadow-color: rgba(0, 255, 0, 0.3);
            --key-bg: #00ff00;
            --key-text: #000;
        }

        :root[data-theme="light"] {
            --bg-gradient-1: #e8f4f8;
            --bg-gradient-2: #d0e8f0;
            --text-primary: #006400;
            --text-secondary: #008000;
            --text-muted: #999;
            --border-primary: #008000;
            --border-secondary: #0066cc;
            --border-warning: #ff8800;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --panel-bg-alt: rgba(240, 248, 255, 0.95);
            --button-bg: #008000;
            --button-text: #fff;
            --shadow-color: rgba(0, 100, 0, 0.2);
            --key-bg: #008000;
            --key-text: #fff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        #main-layout {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #right-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            grid-column: 2;
            grid-row: 1 / 3;
            height: 100%;
        }

        #right-panel .panel.warning {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        #top-bar-container {
            grid-column: 1;
            grid-row: 1;
        }

        #game-info-panel {
            width: 100%;
        }

        #gamepad-icon.keyboard-mode {
            opacity: 0.3;
        }

        #gamepad-icon:hover,
        #book-icon:hover,
        #camera-icon:hover {
            transform: scale(1.1);
        }

        #gamepad-connection-indicator.connected {
            display: block !important;
        }

        #game-container {
            border: 2px solid var(--border-primary);
            box-shadow: 0 0 20px var(--shadow-color);
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #game-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controller-status-hidden {
            display: none !important;
        }

        .panel {
            padding: 12px;
            background: var(--panel-bg);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.5;
        }

        .panel.secondary {
            border-color: var(--border-secondary);
        }

        .panel.warning {
            border-color: var(--border-warning);
        }

        .panel h3 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 13px;
        }

        .panel.secondary h3 {
            color: var(--border-secondary);
        }

        .panel.warning h3 {
            color: var(--border-warning);
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            gap: 8px;
            font-size: 10px;
        }

        .control-item > span:first-child {
            flex-shrink: 0;
        }

        .control-item > span:last-child {
            text-align: right;
        }

        .key {
            background: var(--key-bg);
            color: var(--key-text);
            padding: 1px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 4px;
            display: inline-block;
            white-space: nowrap;
            font-size: 9px;
        }

        .dev-btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .dev-btn:hover:not(:disabled) {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .dev-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .dev-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dev-btn.secondary {
            background: var(--border-secondary);
        }

        .dev-btn.warning {
            background: var(--border-warning);
        }

        /* REMOVED: #fish-status-container - now using GameHUD scene */

        .status-value {
            font-weight: bold;
        }

        .status-connected {
            color: var(--text-primary);
        }

        .status-disconnected {
            color: #ff6666;
        }

        /* Hide help text by default when in a hidden state */
        #controller-help.hidden {
            display: none !important;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .collapsible-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Responsive */
        @media (max-width: 1600px) {
            #main-layout {
                grid-template-columns: 1fr 280px;
            }
        }

        @media (max-width: 1200px) {
            #main-layout {
                grid-template-columns: 1fr;
                max-width: 900px;
            }

            #game-container {
                order: 1;
            }

            #right-panel {
                order: 2;
            }
        }

        /* REMOVED: Scrollbar styles for #fish-status-container - now using GameHUD scene */
    </style>
</head>
<body>
    <!-- Game container only - all UI now rendered in-game via GameHUD scene -->
    <div id="game-container"></div>

    <!-- Load Phaser from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

    <!-- Load html2canvas for screenshot functionality -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Load game modules -->
    <script type="module" src="src/index.ts"></script>

    <!-- Collapsible Section Controls -->
    <script>
        function toggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(contentId.replace('-content', '-toggle'));

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }
    </script>

    <!-- HUD toggle keyboard shortcuts (M, S, F) now handled by GameHUD scene -->

    <!-- Initialize Gamepad Manager and Test Button -->
    <script type="module">
        import gamepadManager from './src/utils/GamepadManager';

        // Make gamepad manager globally available for Phaser scenes
        window.gamepadManager = gamepadManager;

        // Function to show test controller overlay
        function showTestController() {
            const gamepad = gamepadManager.getGamepad();

            // Start in gamepad mode if controller is connected, otherwise keyboard mode
            let currentMode = gamepad ? 'gamepad' : 'keyboard';

            // Create test overlay
            const overlay = document.createElement('div');
            overlay.id = 'test-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                color: #00ff00;
                font-family: 'Courier New', monospace;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 40px;
                box-sizing: border-box;
            `;

            overlay.innerHTML = `
                <div style="max-width: 800px; width: 100%;">
                    <h2 style="text-align: center; color: #00aaff; margin-bottom: 20px;">INPUT TEST MODE</h2>

                    <!-- Toggle Switch -->
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <button id="mode-toggle-gamepad" style="background: #00aaff; color: #000; border: none; padding: 10px 20px; font-size: 20px; border-radius: 5px; cursor: pointer; transition: all 0.2s;">
                            üéÆ Gamepad
                        </button>
                        <button id="mode-toggle-keyboard" style="background: #444; color: #888; border: none; padding: 10px 20px; font-size: 20px; border-radius: 5px; cursor: pointer; transition: all 0.2s;">
                            ‚å®Ô∏è Keyboard
                        </button>
                    </div>

                    <!-- Gamepad Mode Content -->
                    <div id="gamepad-mode-content" style="display: block;">
                        <div style="background: rgba(0, 50, 100, 0.3); padding: 20px; border: 2px solid #00aaff; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 14px; margin-bottom: 10px;">
                                <strong>Controller:</strong> <span id="test-controller-name">${gamepad ? gamepad.id : 'No controller connected'}</span>
                            </div>
                            <div style="font-size: 12px; color: #888;">
                                Press any button or move any stick to see its state
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: rgba(0, 100, 0, 0.2); padding: 15px; border: 1px solid #00ff00; border-radius: 5px;">
                                <h3 style="margin: 0 0 10px 0; color: #ffff00;">BUTTONS</h3>
                                <div id="test-buttons" style="font-size: 11px; line-height: 1.8; font-family: monospace;"></div>
                            </div>

                            <div style="background: rgba(0, 100, 0, 0.2); padding: 15px; border: 1px solid #00ff00; border-radius: 5px;">
                                <h3 style="margin: 0 0 10px 0; color: #ffff00;">AXES (STICKS)</h3>
                                <div id="test-axes" style="font-size: 11px; line-height: 1.8; font-family: monospace;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Keyboard Mode Content -->
                    <div id="keyboard-mode-content" style="display: none;">
                        <div style="background: rgba(0, 50, 100, 0.3); padding: 20px; border: 2px solid #00aaff; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 14px; margin-bottom: 10px;">
                                <strong>Keyboard Controls Tester</strong>
                            </div>
                            <div style="font-size: 12px; color: #888;">
                                Press keys to test hand placement and see control mapping
                            </div>
                        </div>

                        <div style="background: rgba(0, 100, 0, 0.2); padding: 20px; border: 1px solid #00ff00; border-radius: 5px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: #ffff00; text-align: center;">GAME CONTROLS</h3>
                            <div id="keyboard-controls-display" style="font-size: 12px; line-height: 2;">
                                <div><span id="key-up" style="display: inline-block; width: 120px; color: #888;">‚Üë / W</span> Move Up</div>
                                <div><span id="key-down" style="display: inline-block; width: 120px; color: #888;">‚Üì / S</span> Move Down</div>
                                <div><span id="key-left" style="display: inline-block; width: 120px; color: #888;">‚Üê / A</span> Move Left</div>
                                <div><span id="key-right" style="display: inline-block; width: 120px; color: #888;">‚Üí / D</span> Move Right</div>
                                <div style="margin-top: 10px;"><span id="key-space" style="display: inline-block; width: 120px; color: #888;">SPACE</span> Jig Lure / Confirm</div>
                                <div><span id="key-r" style="display: inline-block; width: 120px; color: #888;">R</span> Reset / Restart</div>
                                <div><span id="key-p" style="display: inline-block; width: 120px; color: #888;">P</span> Pause</div>
                                <div><span id="key-esc" style="display: inline-block; width: 120px; color: #888;">ESC</span> Return to Menu</div>
                                <div style="margin-top: 10px;"><span id="key-m" style="display: inline-block; width: 120px; color: #888;">M</span> Toggle Top Bar</div>
                                <div style="margin-top: 10px;"><span id="key-enter" style="display: inline-block; width: 120px; color: #888;">ENTER</span> Start Game</div>
                            </div>
                        </div>

                        <div style="text-align: center; font-size: 11px; color: #888;">
                            Press any key listed above to highlight it
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button id="close-test-btn" style="background: #ff6666; color: #000; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer;">
                            CLOSE TEST (Press ESC)
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const buttonsDiv = document.getElementById('test-buttons');
            const axesDiv = document.getElementById('test-axes');
            const closeBtn = document.getElementById('close-test-btn');
            const modeToggleGamepad = document.getElementById('mode-toggle-gamepad');
            const modeToggleKeyboard = document.getElementById('mode-toggle-keyboard');
            const gamepadModeContent = document.getElementById('gamepad-mode-content');
            const keyboardModeContent = document.getElementById('keyboard-mode-content');

            // Toggle mode function
            function switchMode(mode) {
                currentMode = mode;

                if (mode === 'gamepad') {
                    gamepadModeContent.style.display = 'block';
                    keyboardModeContent.style.display = 'none';
                    modeToggleGamepad.style.background = '#00aaff';
                    modeToggleGamepad.style.color = '#000';
                    modeToggleKeyboard.style.background = '#444';
                    modeToggleKeyboard.style.color = '#888';
                } else {
                    gamepadModeContent.style.display = 'none';
                    keyboardModeContent.style.display = 'block';
                    modeToggleGamepad.style.background = '#444';
                    modeToggleGamepad.style.color = '#888';
                    modeToggleKeyboard.style.background = '#00aaff';
                    modeToggleKeyboard.style.color = '#000';
                }
            }

            // Set initial mode
            switchMode(currentMode);

            // Toggle button handlers
            modeToggleGamepad.addEventListener('click', () => switchMode('gamepad'));
            modeToggleKeyboard.addEventListener('click', () => switchMode('keyboard'));

            // Button names for gamepad display
            const buttonNames = [
                'X (A)', 'Circle (B)', 'Square (X)', 'Triangle (Y)',
                'L1 (LB)', 'R1 (RB)', 'L2 (LT)', 'R2 (RT)',
                'Select', 'Start', 'L3', 'R3',
                'D-Up', 'D-Down', 'D-Left', 'D-Right'
            ];

            // Keyboard key mapping
            const keyElements = {
                'ArrowUp': 'key-up',
                'KeyW': 'key-up',
                'ArrowDown': 'key-down',
                'KeyS': 'key-down',
                'ArrowLeft': 'key-left',
                'KeyA': 'key-left',
                'ArrowRight': 'key-right',
                'KeyD': 'key-right',
                'Space': 'key-space',
                'KeyR': 'key-r',
                'KeyP': 'key-p',
                'Escape': 'key-esc',
                'KeyM': 'key-m',
                'Enter': 'key-enter'
            };

            // Track active keys
            const activeKeys = new Set();

            // Keyboard event handlers
            const keydownHandler = (e) => {
                if (currentMode === 'keyboard') {
                    const elementId = keyElements[e.code];
                    if (elementId) {
                        activeKeys.add(e.code);
                        const el = document.getElementById(elementId);
                        if (el) {
                            el.style.color = '#00ff00';
                            el.style.fontWeight = 'bold';
                        }
                    }
                }
            };

            const keyupHandler = (e) => {
                if (currentMode === 'keyboard') {
                    const elementId = keyElements[e.code];
                    if (elementId) {
                        activeKeys.delete(e.code);
                        const el = document.getElementById(elementId);
                        if (el) {
                            el.style.color = '#888';
                            el.style.fontWeight = 'normal';
                        }
                    }
                }
            };

            document.addEventListener('keydown', keydownHandler);
            document.addEventListener('keyup', keyupHandler);

            // Update gamepad test display
            let testInterval = setInterval(() => {
                if (currentMode === 'gamepad') {
                    const currentGamepad = gamepadManager.getGamepad();
                    if (!currentGamepad) {
                        buttonsDiv.innerHTML = '<div style="color: #ff6666;">No gamepad connected</div>';
                        axesDiv.innerHTML = '<div style="color: #ff6666;">No gamepad connected</div>';
                        return;
                    }

                    // Update buttons
                    let buttonsHTML = '';
                    currentGamepad.buttons.forEach((button, i) => {
                        const name = buttonNames[i] || `Button ${i}`;
                        const pressed = button.pressed ? 'üü¢ PRESSED' : '‚ö´ Released';
                        const value = button.value.toFixed(2);
                        const color = button.pressed ? '#00ff00' : '#666';
                        buttonsHTML += `<div style="color: ${color};">${name.padEnd(15)} ${pressed} (${value})</div>`;
                    });
                    buttonsDiv.innerHTML = buttonsHTML;

                    // Update axes
                    let axesHTML = '';
                    const axisNames = ['Left X', 'Left Y', 'Right X', 'Right Y'];
                    currentGamepad.axes.forEach((value, i) => {
                        const name = axisNames[i] || `Axis ${i}`;
                        const bar = '‚ñà'.repeat(Math.abs(value * 10));
                        const direction = value > 0 ? '‚Üí' : value < 0 ? '‚Üê' : '¬∑';
                        axesHTML += `<div>${name.padEnd(10)} ${direction} ${bar} ${value.toFixed(3)}</div>`;
                    });
                    axesDiv.innerHTML = axesHTML;

                    // Check for Start button to close
                    if (currentGamepad.buttons[9]?.pressed) {
                        clearInterval(testInterval);
                        document.removeEventListener('keydown', keydownHandler);
                        document.removeEventListener('keyup', keyupHandler);
                        overlay.remove();
                    }
                }
            }, 50); // 20 Hz update rate

            // Close button handler
            closeBtn.addEventListener('click', () => {
                clearInterval(testInterval);
                document.removeEventListener('keydown', keydownHandler);
                document.removeEventListener('keyup', keyupHandler);
                overlay.remove();
            });

            // ESC key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    clearInterval(testInterval);
                    document.removeEventListener('keydown', keydownHandler);
                    document.removeEventListener('keyup', keyupHandler);
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Check Gamepads function - manual diagnostic
        function checkGamepads() {
            if (!navigator.getGamepads) {
                alert('‚ùå Gamepad API not supported in this browser!');
                return;
            }

            const gamepads = navigator.getGamepads();

            let foundCount = 0;
            let message = 'Gamepad Check Results:\n\n';

            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    foundCount++;
                    const pad = gamepads[i];
                    message += `‚úÖ Gamepad ${i}: ${pad.id}\n`;
                    message += `   Connected: ${pad.connected}\n`;
                    message += `   Buttons: ${pad.buttons.length}\n`;
                    message += `   Axes: ${pad.axes.length}\n\n`;
                }
            }

            if (foundCount === 0) {
                message += '‚ùå No gamepads detected.\n\n';
                message += 'IMPORTANT: You must press a button on your\n';
                message += 'controller before the browser can detect it.\n\n';
                message += 'Steps:\n';
                message += '1. Make sure controller is ON and connected\n';
                message += '2. Press ANY button on the controller\n';
                message += '3. Click "Check Gamepads" again\n';
            } else {
                message += `‚úÖ Found ${foundCount} gamepad(s)!`;
            }

            alert(message);
        }

        // Setup gamepad icon click handler
        const gamepadIconContainer = document.getElementById('gamepad-icon-container');
        if (gamepadIconContainer) {
            gamepadIconContainer.addEventListener('click', showTestController);
        }

        // Setup book icon click handler (Species Guide)
        const bookIconContainer = document.getElementById('book-icon-container');
        if (bookIconContainer) {
            bookIconContainer.addEventListener('click', () => {
            // Create species guide overlay
            const overlay = document.createElement('div');
            overlay.id = 'species-guide-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                color: #00ff00;
                font-family: 'Courier New', monospace;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 40px;
                box-sizing: border-box;
                overflow-y: auto;
            `;

            overlay.innerHTML = `
                <div style="max-width: 900px; width: 100%;">
                    <h1 style="text-align: center; color: #00aaff; margin-bottom: 20px;">üìñ LAKE CHAMPLAIN SPECIES GUIDE</h1>
                    <div style="background: rgba(0, 50, 100, 0.3); padding: 20px; border: 2px solid #00aaff; border-radius: 10px; margin-bottom: 20px;">
                        <p style="font-size: 14px; margin: 0; text-align: center; color: #888;">
                            Your comprehensive reference for Lake Champlain species, behavior patterns, and fishing techniques
                        </p>
                    </div>

                    <div style="background: rgba(0, 100, 0, 0.2); padding: 20px; border: 2px solid #00ff00; border-radius: 10px; margin-bottom: 20px;">
                        <h2 style="color: #ffff00; margin-top: 0;">üéØ Game Species</h2>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00ff00; margin: 0 0 10px 0;">Northern Pike (Esox lucius)</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Ambush predator, prefers shallow weedy areas, active hunters</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Depth Range:</strong> 5-40 feet, often near vegetation</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Target:</strong> Aggressively chases baitfish, attracted to movement</p>
                        </div>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00ff00; margin: 0 0 10px 0;">Lake Trout (Salvelinus namaycush)</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Deep water specialist, cold-water lover, slow methodical hunter</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Depth Range:</strong> 40-150 feet, stays in thermocline</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Target:</strong> Prefers slower presentations near lake bottom</p>
                        </div>

                        <h2 style="color: #ffff00; margin-top: 30px;">üêü Baitfish</h2>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00aaff; margin: 0 0 10px 0;">Alewife</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Schools tightly when threatened, moves in coordinated patterns</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Pattern:</strong> Primary forage for all game fish</p>
                        </div>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00aaff; margin: 0 0 10px 0;">Smelt</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Smaller, faster schools, often found in mid-water column</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Pattern:</strong> Attracts larger predators when schooling</p>
                        </div>

                        <h2 style="color: #ffff00; margin-top: 30px;">üí° Fishing Tips</h2>
                        <ul style="font-size: 12px; line-height: 1.8;">
                            <li>Watch for baitfish schools - predators follow their prey</li>
                            <li>Match your depth to where fish are actively feeding</li>
                            <li>Pike prefer faster-moving targets near structure</li>
                            <li>Lake trout hunt methodically in deeper, colder water</li>
                            <li>Adjust your jigging speed based on fish activity</li>
                        </ul>
                    </div>

                    <div style="text-align: center;">
                        <button id="close-species-guide" style="background: #ff6666; color: #000; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer;">
                            CLOSE (Press ESC)
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const closeBtn = document.getElementById('close-species-guide');

            // Close button handler
            closeBtn.addEventListener('click', () => {
                overlay.remove();
            });

            // ESC key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

            // Click background to close
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
            });
        }

        // Setup camera icon click handler (Screenshot Feature)
        const cameraIconContainer = document.getElementById('camera-icon-container');
        if (cameraIconContainer) {
            cameraIconContainer.addEventListener('click', async () => {
            try {
                // Capture screenshot FIRST (before showing any UI)
                const canvas = await html2canvas(document.body, {
                    backgroundColor: '#000000',
                    scale: 1,
                    logging: false,
                    useCORS: true
                });

                // Convert canvas to data URL
                const screenshotDataUrl = canvas.toDataURL('image/png');

                // Create screenshot modal
                const overlay = document.createElement('div');
                overlay.id = 'screenshot-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    z-index: 10000;
                    overflow-y: auto;
                    padding: 40px;
                    box-sizing: border-box;
                `;

                overlay.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; background: var(--panel-bg-alt); border: 2px solid var(--border-primary); border-radius: 10px; padding: 30px;">
                        <h1 style="text-align: center; color: var(--text-primary); margin: 0 0 20px 0; font-family: 'Courier New', monospace;">üì∑ Screenshot Captured</h1>

                        <div style="margin-bottom: 20px; border: 2px solid var(--border-secondary); border-radius: 5px; overflow: hidden;">
                            <img src="${screenshotDataUrl}" style="width: 100%; height: auto; display: block;" alt="Screenshot preview">
                        </div>

                        <div style="background: rgba(0, 100, 0, 0.2); padding: 20px; border: 2px solid var(--border-primary); border-radius: 10px; margin-bottom: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-primary); font-family: 'Courier New', monospace; font-weight: bold; margin-bottom: 5px;">
                                    Title:
                                </label>
                                <input
                                    type="text"
                                    id="screenshot-title"
                                    placeholder="Enter a title for this issue..."
                                    style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border-secondary); border-radius: 5px; color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 14px; box-sizing: border-box;"
                                >
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-primary); font-family: 'Courier New', monospace; font-weight: bold; margin-bottom: 5px;">
                                    Description:
                                </label>
                                <textarea
                                    id="screenshot-description"
                                    placeholder="Describe what you see or what issue you're reporting..."
                                    rows="6"
                                    style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border-secondary); border-radius: 5px; color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; box-sizing: border-box;"
                                ></textarea>
                            </div>
                        </div>

                        <div id="screenshot-status-message" style="display: none; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-family: 'Courier New', monospace; text-align: center;"></div>

                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button id="download-screenshot-btn" style="background: var(--button-bg); color: var(--button-text); border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer; transition: transform 0.1s;">
                                üíæ Download PNG
                            </button>
                            <button id="copy-markdown-btn" style="background: #4CAF50; color: #fff; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer; transition: transform 0.1s;">
                                üìã Copy Issue Markdown
                            </button>
                            <button id="close-screenshot-btn" style="background: #ff6666; color: #000; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer; transition: transform 0.1s;">
                                ‚úñ Close (ESC)
                            </button>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: rgba(0, 100, 200, 0.2); border: 2px solid var(--border-secondary); border-radius: 5px;">
                            <p style="margin: 0; font-size: 12px; color: #888; text-align: center; font-family: 'Courier New', monospace;">
                                ‚ÑπÔ∏è Download the screenshot as a PNG file or copy formatted markdown to create a GitHub issue manually.
                            </p>
                        </div>
                    </div>
                `;

                document.body.appendChild(overlay);

                const titleInput = document.getElementById('screenshot-title');
                const descriptionInput = document.getElementById('screenshot-description');
                const downloadBtn = document.getElementById('download-screenshot-btn');
                const copyMarkdownBtn = document.getElementById('copy-markdown-btn');
                const closeBtn = document.getElementById('close-screenshot-btn');
                const statusMessage = document.getElementById('screenshot-status-message');

                // Focus on title input
                titleInput.focus();

                // Function to show status message
                function showStatus(message, isSuccess) {
                    statusMessage.textContent = message;
                    statusMessage.style.display = 'block';
                    statusMessage.style.background = isSuccess ? 'rgba(0, 255, 0, 0.2)' : 'rgba(255, 0, 0, 0.2)';
                    statusMessage.style.border = isSuccess ? '2px solid #00ff00' : '2px solid #ff6666';
                    statusMessage.style.color = isSuccess ? '#00ff00' : '#ff6666';
                }

                // Save to localStorage
                function saveToLocalStorage() {
                    const title = titleInput.value.trim();
                    const description = descriptionInput.value.trim();

                    if (title || description) {
                        const screenshotData = {
                            title: title || 'Untitled Screenshot',
                            description: description || 'No description provided',
                            imageData: screenshotDataUrl,
                            timestamp: new Date().toISOString()
                        };
                        const existingScreenshots = JSON.parse(localStorage.getItem('wolfpack-screenshots') || '[]');
                        existingScreenshots.push(screenshotData);
                        localStorage.setItem('wolfpack-screenshots', JSON.stringify(existingScreenshots));
                    }
                }

                // Download button handler
                downloadBtn.addEventListener('click', () => {
                    const title = titleInput.value.trim() || 'wolfpack-screenshot';
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    const filename = `${title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${timestamp}.png`;

                    // Create download link
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = screenshotDataUrl;
                    link.click();

                    // Save to localStorage
                    saveToLocalStorage();

                    showStatus(`‚úÖ Screenshot downloaded as ${filename}`, true);
                });

                // Copy markdown button handler
                copyMarkdownBtn.addEventListener('click', async () => {
                    const title = titleInput.value.trim();
                    const description = descriptionInput.value.trim();

                    if (!title) {
                        showStatus('‚ö†Ô∏è Please enter a title first', false);
                        titleInput.focus();
                        return;
                    }

                    // Generate markdown for GitHub issue
                    const markdown = `## ${title}

${description || 'No description provided'}

### Screenshot
![Screenshot](screenshot.png)

---
**Captured:** ${new Date().toLocaleString()}
**Device:** ${navigator.userAgent}

> Note: To create this issue on GitHub:
> 1. Download the screenshot using the "Download PNG" button
> 2. Create a new issue on GitHub
> 3. Paste this markdown as the issue description
> 4. Attach the downloaded screenshot file
> 5. Add labels: \`bug\`, \`screenshot\``;

                    try {
                        await navigator.clipboard.writeText(markdown);
                        showStatus('‚úÖ Issue markdown copied to clipboard!', true);

                        // Save to localStorage
                        saveToLocalStorage();
                    } catch (error) {
                        console.error('Failed to copy to clipboard:', error);
                        showStatus('‚ö†Ô∏è Failed to copy to clipboard. Please try again.', false);
                    }
                });

                // Close button handler
                closeBtn.addEventListener('click', () => {
                    overlay.remove();
                });

                // ESC key handler
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);

                // Click background to close
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });

                // Clean up event listener when overlay is removed
                overlay.addEventListener('remove', () => {
                    document.removeEventListener('keydown', escHandler);
                });

            } catch (error) {
                console.error('Screenshot capture failed:', error);
                alert('Failed to capture screenshot. Please try again.');
            }
            });
        }

    </script>
</body>
</html>
