<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wolfpack - Lake Champlain Ice Fishing</title>
    <style>
        :root[data-theme="dark"] {
            --bg-gradient-1: #1a2332;
            --bg-gradient-2: #0d1117;
            --text-primary: #00ff00;
            --text-secondary: #88ff88;
            --text-muted: #666;
            --border-primary: #00ff00;
            --border-secondary: #00aaff;
            --border-warning: #ffaa00;
            --panel-bg: rgba(0, 0, 0, 0.7);
            --panel-bg-alt: rgba(20, 20, 50, 0.9);
            --button-bg: #00ff00;
            --button-text: #000;
            --shadow-color: rgba(0, 255, 0, 0.3);
            --key-bg: #00ff00;
            --key-text: #000;
        }

        :root[data-theme="light"] {
            --bg-gradient-1: #e8f4f8;
            --bg-gradient-2: #d0e8f0;
            --text-primary: #006400;
            --text-secondary: #008000;
            --text-muted: #999;
            --border-primary: #008000;
            --border-secondary: #0066cc;
            --border-warning: #ff8800;
            --panel-bg: rgba(255, 255, 255, 0.9);
            --panel-bg-alt: rgba(240, 248, 255, 0.95);
            --button-bg: #008000;
            --button-text: #fff;
            --shadow-color: rgba(0, 100, 0, 0.2);
            --key-bg: #008000;
            --key-text: #fff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 10px;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }


        #main-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            grid-template-rows: auto 1fr;
            gap: 10px;
            width: 100%;
            height: 100%;
            margin: 0 auto;
            align-items: start;
        }

        #right-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
            grid-column: 2;
            grid-row: 1 / 3;
            height: 100%;
        }

        #right-panel .panel.warning {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        #top-bar-container {
            grid-column: 1;
            grid-row: 1;
        }

        #game-info-panel {
            width: 100%;
        }

        #gamepad-icon.keyboard-mode {
            opacity: 0.3;
        }

        #gamepad-icon:hover,
        #book-icon:hover,
        #camera-icon:hover {
            transform: scale(1.1);
        }

        #gamepad-connection-indicator.connected {
            display: block !important;
        }

        #game-container {
            border: 2px solid var(--border-primary);
            box-shadow: 0 0 20px var(--shadow-color);
            position: relative;
            margin: 0 auto;
            grid-column: 1;
            grid-row: 2;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #game-container canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .controller-status-hidden {
            display: none !important;
        }

        .panel {
            padding: 12px;
            background: var(--panel-bg);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.5;
        }

        .panel.secondary {
            border-color: var(--border-secondary);
        }

        .panel.warning {
            border-color: var(--border-warning);
        }

        .panel h3 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 13px;
        }

        .panel.secondary h3 {
            color: var(--border-secondary);
        }

        .panel.warning h3 {
            color: var(--border-warning);
        }

        .control-item {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
            gap: 8px;
            font-size: 10px;
        }

        .control-item > span:first-child {
            flex-shrink: 0;
        }

        .control-item > span:last-child {
            text-align: right;
        }

        .key {
            background: var(--key-bg);
            color: var(--key-text);
            padding: 1px 6px;
            border-radius: 3px;
            font-weight: bold;
            margin-right: 4px;
            display: inline-block;
            white-space: nowrap;
            font-size: 9px;
        }

        .dev-btn {
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 12px;
            margin: 2px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .dev-btn:hover:not(:disabled) {
            opacity: 0.8;
            transform: scale(1.02);
        }

        .dev-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .dev-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dev-btn.secondary {
            background: var(--border-secondary);
        }

        .dev-btn.warning {
            background: var(--border-warning);
        }

        #fish-status-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            font-size: 10px;
            line-height: 1.4;
            min-height: 0;
        }

        .status-value {
            font-weight: bold;
        }

        .status-connected {
            color: var(--text-primary);
        }

        .status-disconnected {
            color: #ff6666;
        }

        /* Hide help text by default when in a hidden state */
        #controller-help.hidden {
            display: none !important;
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapsible-toggle {
            font-size: 12px;
            transition: transform 0.2s;
        }

        .collapsible-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        /* Top Bar Toggle Button */
        #topbar-toggle {
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }

        #topbar-toggle:hover {
            transform: scale(1.1);
        }

        /* Sidebar Toggle Button */
        #sidebar-toggle {
            font-size: 24px;
            line-height: 1;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
        }

        #sidebar-toggle:hover {
            transform: scale(1.1);
        }

        /* Top bar collapsed state */
        body.topbar-collapsed #top-bar-container {
            display: none;
        }

        body.topbar-collapsed #main-layout {
            grid-template-rows: 0px 1fr !important;
        }

        /* Sidebar collapsed state */
        body.sidebar-collapsed #main-layout {
            grid-template-columns: 1fr 0px !important;
        }

        body.sidebar-collapsed #right-panel {
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
            width: 0;
            min-width: 0;
        }

        /* Responsive */
        @media (max-width: 1600px) {
            #main-layout {
                grid-template-columns: 1fr 280px;
            }
        }

        @media (max-width: 1200px) {
            #main-layout {
                grid-template-columns: 1fr;
                max-width: 900px;
            }

            #game-container {
                order: 1;
            }

            #right-panel {
                order: 2;
            }
        }

        /* Scrollbar styling for dark theme */
        :root[data-theme="dark"] #fish-status-container::-webkit-scrollbar,
        :root[data-theme="dark"] #fish-status-container div::-webkit-scrollbar {
            width: 6px;
        }

        :root[data-theme="dark"] #fish-status-container::-webkit-scrollbar-track,
        :root[data-theme="dark"] #fish-status-container div::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        :root[data-theme="dark"] #fish-status-container::-webkit-scrollbar-thumb,
        :root[data-theme="dark"] #fish-status-container div::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 3px;
        }

        /* Scrollbar styling for light theme */
        :root[data-theme="light"] #fish-status-container::-webkit-scrollbar,
        :root[data-theme="light"] #fish-status-container div::-webkit-scrollbar {
            width: 6px;
        }

        :root[data-theme="light"] #fish-status-container::-webkit-scrollbar-track,
        :root[data-theme="light"] #fish-status-container div::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        :root[data-theme="light"] #fish-status-container::-webkit-scrollbar-thumb,
        :root[data-theme="light"] #fish-status-container div::-webkit-scrollbar-thumb {
            background: var(--border-primary);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="main-layout">
        <!-- Top Bar Container (Game Info Panel with integrated icons) -->
        <div id="top-bar-container">
            <!-- Game Info Panel -->
            <div id="game-info-panel" class="panel">
                <div style="display: grid; grid-template-columns: repeat(10, 1fr) auto auto auto; gap: 8px; font-size: 10px; align-items: center;">
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">LINE <span id="ui-line-test" style="color: var(--text-primary);">15lb</span></div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <div style="flex: 1; height: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--text-muted); border-radius: 2px; position: relative; overflow: hidden; min-width: 40px;">
                                <div id="line-strain-fill" style="position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff9900 75%, #ff0000 100%); transition: width 0.1s linear;"></div>
                            </div>
                            <div style="color: var(--text-primary); font-size: 9px; font-weight: bold; min-width: 22px;">
                                <span id="line-strain-percent">0</span>%
                            </div>
                        </div>
                    </div>
                    <div id="depth-display">
                        <div style="color: var(--text-muted); font-size: 8px;">DEPTH</div>
                        <div style="font-weight: bold; color: var(--border-secondary); font-size: 11px; display: flex; align-items: center; gap: 4px;">
                            <span id="ui-depth">0</span>ft
                            <span id="nature-depth-selector" style="display: none; cursor: pointer; font-size: 14px; user-select: none;" title="Change depth settings">‚¨ç</span>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">TENSION</div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <div style="flex: 1; height: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--text-muted); border-radius: 2px; position: relative; overflow: hidden; min-width: 40px;">
                                <div id="tension-fill" style="position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff6600 70%, #ff0000 100%); transition: width 0.1s linear;"></div>
                            </div>
                            <div style="color: var(--text-primary); font-size: 9px; font-weight: bold; min-width: 22px;">
                                <span id="tension-percent">0</span>%
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">DROP</div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <div style="flex: 1; height: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--text-muted); border-radius: 2px; position: relative; overflow: hidden; min-width: 40px;">
                                <div id="drop-speed-fill" style="position: absolute; right: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #ff6600 0%, #ffff00 50%, #00ff00 100%); transition: width 0.05s linear;"></div>
                            </div>
                            <div style="color: var(--text-primary); font-size: 9px; font-weight: bold; min-width: 22px;">
                                <span id="drop-speed-percent">0</span>%
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">REEL</div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <div style="flex: 1; height: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--text-muted); border-radius: 2px; position: relative; overflow: hidden; min-width: 40px;">
                                <div id="reel-speed-fill" style="position: absolute; left: 0; top: 0; bottom: 0; width: 0%; background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff6600 100%); transition: width 0.05s linear;"></div>
                            </div>
                            <div style="color: var(--text-primary); font-size: 9px; font-weight: bold; min-width: 22px;">
                                <span id="reel-speed-percent">0</span>%
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">DRAG</div>
                        <div style="display: flex; align-items: center; gap: 3px;">
                            <div style="flex: 1; height: 10px; background: rgba(0, 0, 0, 0.5); border: 1px solid var(--text-muted); border-radius: 2px; position: relative; overflow: hidden; min-width: 40px;">
                                <div id="drag-setting-fill" style="position: absolute; left: 0; top: 0; bottom: 0; width: 50%; background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff6600 100%); transition: width 0.05s linear;"></div>
                            </div>
                            <div style="color: var(--text-primary); font-size: 9px; font-weight: bold; min-width: 22px;">
                                <span id="drag-setting-percent">50</span>%
                            </div>
                        </div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">TEMP</div>
                        <div style="font-weight: bold; color: var(--border-secondary); font-size: 11px;"><span id="ui-temp">40</span>¬∞F</div>
                    </div>
                    <div>
                        <div style="color: var(--text-muted); font-size: 8px;">TIME</div>
                        <div style="font-weight: bold; color: var(--text-primary); font-size: 11px;"><span id="ui-time">0:00</span></div>
                    </div>
                    <!-- Kayak Tiredness (shown when in kayak mode) -->
                    <div id="ui-kayak-status" style="display: none;">
                        <div style="color: var(--text-muted); font-size: 8px;">STAMINA</div>
                        <div style="font-weight: bold; color: var(--text-primary); font-size: 11px;"><span id="ui-kayak-stamina">100</span>%</div>
                    </div>
                    <!-- Motorboat Gas (shown when in motorboat mode) -->
                    <div id="ui-boat-status" style="display: none;">
                        <div style="color: var(--text-muted); font-size: 8px;">FUEL</div>
                        <div style="font-weight: bold; color: var(--text-primary); font-size: 11px;"><span id="ui-boat-fuel">100</span>%</div>
                    </div>
                    <!-- Icon Group (condensed into one cell) -->
                    <div id="icon-group-container" style="display: flex; gap: 6px; align-items: center;">
                        <!-- Gamepad Icon -->
                        <div id="gamepad-icon-container" style="position: relative;">
                            <div id="gamepad-icon" style="font-size: 24px; line-height: 1; cursor: pointer;">üéÆ</div>
                            <div id="gamepad-connection-indicator" style="position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: #00ff00; border-radius: 50%; border: 2px solid var(--bg-gradient-1); display: none; box-shadow: 0 0 8px rgba(0, 255, 0, 0.8);"></div>
                        </div>
                        <!-- Book Icon -->
                        <div id="book-icon-container" style="position: relative;">
                            <div id="book-icon" style="font-size: 24px; line-height: 1; cursor: pointer;">üìñ</div>
                        </div>
                        <!-- Camera Icon -->
                        <div id="camera-icon-container" style="position: relative;">
                            <div id="camera-icon" style="font-size: 24px; line-height: 1; cursor: pointer;" title="Take screenshot">üì∑</div>
                        </div>
                    </div>
                    <!-- Top Bar Toggle (integrated into info bar) -->
                    <div id="topbar-toggle-container" style="position: relative;" title="Toggle top bar">
                        <div id="topbar-toggle">‚ñ≤</div>
                    </div>
                    <!-- Sidebar Toggle (integrated into info bar) -->
                    <div id="sidebar-toggle-container" style="position: relative;" title="Toggle sidebar">
                        <div id="sidebar-toggle">‚ò∞</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center Panel (Game) -->
        <div id="game-container"></div>

        <!-- Version Display (overlays bottom-right of game) -->
        <div id="version-display" style="
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Courier New', monospace;
            font-size: 9px;
            color: #888888;
            cursor: pointer;
            user-select: none;
            z-index: 100;
            padding: 3px 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 3px;
            border: 1px solid #444444;
            transition: all 0.2s;
        " title="Click to view commit history">
            <span id="version-hash">loading...</span>
        </div>

        <!-- Right Panel -->
        <div id="right-panel">
            <!-- Fish Status -->
            <div class="panel warning" style="display: flex; flex-direction: column; height: 100%;">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üêü FISH STATUS</span>
                    <span id="entity-counts" style="font-size: 11px; font-weight: normal; color: var(--text-secondary);"></span>
                </h3>
                <div id="fish-status-container" style="flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                    <div style="color: var(--text-muted); font-style: italic;">No fish spawned</div>
                </div>
                <div id="spawn-buttons-container" style="border-top: 2px solid #00ff00; border-bottom: 2px solid #00ff00; background: #0a0a0a; display: none;">
                    <!-- Spawn buttons will be inserted here dynamically -->
                </div>
                <div id="fish-detail-panel" style="min-height: 180px; max-height: 180px; background: #0a0a0a; overflow-y: auto;">
                    <div style="color: #888; font-style: italic; padding: 10px; text-align: center;">Press X for spawn mode</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Phaser from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>

    <!-- Load html2canvas for screenshot functionality -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Load game modules -->
    <script type="module" src="src/index.js"></script>

    <!-- Collapsible Section Controls -->
    <script>
        function toggleCollapse(contentId) {
            const content = document.getElementById(contentId);
            const toggle = document.getElementById(contentId.replace('-content', '-toggle'));

            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.classList.remove('collapsed');
                toggle.textContent = '‚ñº';
            } else {
                content.classList.add('collapsed');
                toggle.classList.add('collapsed');
                toggle.textContent = '‚ñ∂';
            }
        }
    </script>

    <!-- Sidebar Toggle Controls -->
    <script>
        // Load sidebar preference from localStorage
        const sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        if (sidebarCollapsed) {
            document.body.classList.add('sidebar-collapsed');
        }

        // Add click handler for sidebar toggle
        document.addEventListener('DOMContentLoaded', () => {
            const sidebarToggle = document.getElementById('sidebar-toggle');

            sidebarToggle.addEventListener('click', () => {
                const isCollapsed = document.body.classList.toggle('sidebar-collapsed');

                // Save preference
                localStorage.setItem('sidebarCollapsed', isCollapsed);

                // Keep hamburger icon consistent (don't change to X)
                sidebarToggle.textContent = '‚ò∞';

                console.log(isCollapsed ? 'üì± Sidebar collapsed - Full screen mode' : 'üìä Sidebar expanded');
            });

            // Set initial icon (always hamburger)
            sidebarToggle.textContent = '‚ò∞';
        });
    </script>

    <!-- Top Bar Toggle Controls -->
    <script>
        // Load top bar preference from localStorage
        const topbarCollapsed = localStorage.getItem('topbarCollapsed') === 'true';
        if (topbarCollapsed) {
            document.body.classList.add('topbar-collapsed');
        }

        // Add click handler for top bar toggle
        document.addEventListener('DOMContentLoaded', () => {
            const topbarToggle = document.getElementById('topbar-toggle');

            topbarToggle.addEventListener('click', () => {
                const isCollapsed = document.body.classList.toggle('topbar-collapsed');

                // Save preference
                localStorage.setItem('topbarCollapsed', isCollapsed);

                // Keep up arrow consistent (don't change to down)
                topbarToggle.textContent = '‚ñ≤';

                console.log(isCollapsed ? 'üé¨ Top bar hidden - Cinema mode' : 'üìä Top bar visible');
            });

            // Set initial icon (always up arrow)
            topbarToggle.textContent = '‚ñ≤';
        });
    </script>

    <!-- Keyboard Shortcuts -->
    <script>
        document.addEventListener('keydown', (event) => {
            // Don't trigger if user is typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }

            // 'm' key to toggle top bar (same as down arrow)
            if (event.key === 'm' || event.key === 'M') {
                const topbarToggle = document.getElementById('topbar-toggle');
                if (topbarToggle) {
                    topbarToggle.click();
                }
            }

            // 's' key to toggle fish status sidebar (same as hamburger menu)
            if (event.key === 's' || event.key === 'S') {
                const sidebarToggle = document.getElementById('sidebar-toggle');
                if (sidebarToggle) {
                    sidebarToggle.click();
                }
            }

            // 'f' key for cinema mode - hide both topbar and sidebar for maximum screen space
            if (event.key === 'f' || event.key === 'F') {
                const topbarCollapsed = document.body.classList.contains('topbar-collapsed');
                const sidebarCollapsed = document.body.classList.contains('sidebar-collapsed');

                // If both are already hidden, show both
                if (topbarCollapsed && sidebarCollapsed) {
                    if (topbarCollapsed) document.getElementById('topbar-toggle').click();
                    if (sidebarCollapsed) document.getElementById('sidebar-toggle').click();
                    console.log('üìä Normal mode - panels visible');
                } else {
                    // Hide both for cinema mode
                    if (!topbarCollapsed) document.getElementById('topbar-toggle').click();
                    if (!sidebarCollapsed) document.getElementById('sidebar-toggle').click();
                    console.log('üé¨ Cinema mode - maximum screen space');
                }
            }
        });
    </script>

    <!-- Initialize Gamepad Manager and Test Button -->
    <script type="module">
        import gamepadManager from './src/utils/GamepadManager.js';

        // Make gamepad manager globally available for Phaser scenes
        window.gamepadManager = gamepadManager;

        // Track keyboard usage
        let keyboardUsed = false;
        const gamepadIcon = document.getElementById('gamepad-icon');
        const gamepadConnectionIndicator = document.getElementById('gamepad-connection-indicator');

        // Detect keyboard input
        window.addEventListener('keydown', () => {
            if (!gamepadManager.isConnected()) {
                keyboardUsed = true;
                gamepadIcon.classList.add('keyboard-mode');
            }
        });

        // Update gamepad connection indicator
        function updateGamepadUI() {
            if (gamepadManager.isConnected()) {
                keyboardUsed = false;
                gamepadIcon.classList.remove('keyboard-mode');
                gamepadConnectionIndicator.classList.add('connected');
            } else {
                gamepadConnectionIndicator.classList.remove('connected');
                if (keyboardUsed) {
                    gamepadIcon.classList.add('keyboard-mode');
                }
            }
        }

        // Poll for gamepad connection status
        setInterval(updateGamepadUI, 500);

        // Function to show test controller overlay
        function showTestController() {
            const gamepad = gamepadManager.getGamepad();

            // Start in gamepad mode if controller is connected, otherwise keyboard mode
            let currentMode = gamepad ? 'gamepad' : 'keyboard';

            // Create test overlay
            const overlay = document.createElement('div');
            overlay.id = 'test-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                color: #00ff00;
                font-family: 'Courier New', monospace;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 40px;
                box-sizing: border-box;
            `;

            overlay.innerHTML = `
                <div style="max-width: 800px; width: 100%;">
                    <h2 style="text-align: center; color: #00aaff; margin-bottom: 20px;">INPUT TEST MODE</h2>

                    <!-- Toggle Switch -->
                    <div style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 20px;">
                        <button id="mode-toggle-gamepad" style="background: #00aaff; color: #000; border: none; padding: 10px 20px; font-size: 20px; border-radius: 5px; cursor: pointer; transition: all 0.2s;">
                            üéÆ Gamepad
                        </button>
                        <button id="mode-toggle-keyboard" style="background: #444; color: #888; border: none; padding: 10px 20px; font-size: 20px; border-radius: 5px; cursor: pointer; transition: all 0.2s;">
                            ‚å®Ô∏è Keyboard
                        </button>
                    </div>

                    <!-- Gamepad Mode Content -->
                    <div id="gamepad-mode-content" style="display: block;">
                        <div style="background: rgba(0, 50, 100, 0.3); padding: 20px; border: 2px solid #00aaff; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 14px; margin-bottom: 10px;">
                                <strong>Controller:</strong> <span id="test-controller-name">${gamepad ? gamepad.id : 'No controller connected'}</span>
                            </div>
                            <div style="font-size: 12px; color: #888;">
                                Press any button or move any stick to see its state
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: rgba(0, 100, 0, 0.2); padding: 15px; border: 1px solid #00ff00; border-radius: 5px;">
                                <h3 style="margin: 0 0 10px 0; color: #ffff00;">BUTTONS</h3>
                                <div id="test-buttons" style="font-size: 11px; line-height: 1.8; font-family: monospace;"></div>
                            </div>

                            <div style="background: rgba(0, 100, 0, 0.2); padding: 15px; border: 1px solid #00ff00; border-radius: 5px;">
                                <h3 style="margin: 0 0 10px 0; color: #ffff00;">AXES (STICKS)</h3>
                                <div id="test-axes" style="font-size: 11px; line-height: 1.8; font-family: monospace;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Keyboard Mode Content -->
                    <div id="keyboard-mode-content" style="display: none;">
                        <div style="background: rgba(0, 50, 100, 0.3); padding: 20px; border: 2px solid #00aaff; border-radius: 10px; margin-bottom: 20px;">
                            <div style="font-size: 14px; margin-bottom: 10px;">
                                <strong>Keyboard Controls Tester</strong>
                            </div>
                            <div style="font-size: 12px; color: #888;">
                                Press keys to test hand placement and see control mapping
                            </div>
                        </div>

                        <div style="background: rgba(0, 100, 0, 0.2); padding: 20px; border: 1px solid #00ff00; border-radius: 5px; margin-bottom: 20px;">
                            <h3 style="margin: 0 0 15px 0; color: #ffff00; text-align: center;">GAME CONTROLS</h3>
                            <div id="keyboard-controls-display" style="font-size: 12px; line-height: 2;">
                                <div><span id="key-up" style="display: inline-block; width: 120px; color: #888;">‚Üë / W</span> Move Up</div>
                                <div><span id="key-down" style="display: inline-block; width: 120px; color: #888;">‚Üì / S</span> Move Down</div>
                                <div><span id="key-left" style="display: inline-block; width: 120px; color: #888;">‚Üê / A</span> Move Left</div>
                                <div><span id="key-right" style="display: inline-block; width: 120px; color: #888;">‚Üí / D</span> Move Right</div>
                                <div style="margin-top: 10px;"><span id="key-space" style="display: inline-block; width: 120px; color: #888;">SPACE</span> Jig Lure / Confirm</div>
                                <div><span id="key-r" style="display: inline-block; width: 120px; color: #888;">R</span> Reset / Restart</div>
                                <div><span id="key-p" style="display: inline-block; width: 120px; color: #888;">P</span> Pause</div>
                                <div><span id="key-esc" style="display: inline-block; width: 120px; color: #888;">ESC</span> Return to Menu</div>
                                <div style="margin-top: 10px;"><span id="key-m" style="display: inline-block; width: 120px; color: #888;">M</span> Toggle Top Bar</div>
                                <div style="margin-top: 10px;"><span id="key-enter" style="display: inline-block; width: 120px; color: #888;">ENTER</span> Start Game</div>
                            </div>
                        </div>

                        <div style="text-align: center; font-size: 11px; color: #888;">
                            Press any key listed above to highlight it
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button id="close-test-btn" style="background: #ff6666; color: #000; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer;">
                            CLOSE TEST (Press ESC)
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const buttonsDiv = document.getElementById('test-buttons');
            const axesDiv = document.getElementById('test-axes');
            const closeBtn = document.getElementById('close-test-btn');
            const modeToggleGamepad = document.getElementById('mode-toggle-gamepad');
            const modeToggleKeyboard = document.getElementById('mode-toggle-keyboard');
            const gamepadModeContent = document.getElementById('gamepad-mode-content');
            const keyboardModeContent = document.getElementById('keyboard-mode-content');

            // Toggle mode function
            function switchMode(mode) {
                currentMode = mode;

                if (mode === 'gamepad') {
                    gamepadModeContent.style.display = 'block';
                    keyboardModeContent.style.display = 'none';
                    modeToggleGamepad.style.background = '#00aaff';
                    modeToggleGamepad.style.color = '#000';
                    modeToggleKeyboard.style.background = '#444';
                    modeToggleKeyboard.style.color = '#888';
                } else {
                    gamepadModeContent.style.display = 'none';
                    keyboardModeContent.style.display = 'block';
                    modeToggleGamepad.style.background = '#444';
                    modeToggleGamepad.style.color = '#888';
                    modeToggleKeyboard.style.background = '#00aaff';
                    modeToggleKeyboard.style.color = '#000';
                }
            }

            // Set initial mode
            switchMode(currentMode);

            // Toggle button handlers
            modeToggleGamepad.addEventListener('click', () => switchMode('gamepad'));
            modeToggleKeyboard.addEventListener('click', () => switchMode('keyboard'));

            // Button names for gamepad display
            const buttonNames = [
                'X (A)', 'Circle (B)', 'Square (X)', 'Triangle (Y)',
                'L1 (LB)', 'R1 (RB)', 'L2 (LT)', 'R2 (RT)',
                'Select', 'Start', 'L3', 'R3',
                'D-Up', 'D-Down', 'D-Left', 'D-Right'
            ];

            // Keyboard key mapping
            const keyElements = {
                'ArrowUp': 'key-up',
                'KeyW': 'key-up',
                'ArrowDown': 'key-down',
                'KeyS': 'key-down',
                'ArrowLeft': 'key-left',
                'KeyA': 'key-left',
                'ArrowRight': 'key-right',
                'KeyD': 'key-right',
                'Space': 'key-space',
                'KeyR': 'key-r',
                'KeyP': 'key-p',
                'Escape': 'key-esc',
                'KeyM': 'key-m',
                'Enter': 'key-enter'
            };

            // Track active keys
            const activeKeys = new Set();

            // Keyboard event handlers
            const keydownHandler = (e) => {
                if (currentMode === 'keyboard') {
                    const elementId = keyElements[e.code];
                    if (elementId) {
                        activeKeys.add(e.code);
                        const el = document.getElementById(elementId);
                        if (el) {
                            el.style.color = '#00ff00';
                            el.style.fontWeight = 'bold';
                        }
                    }
                }
            };

            const keyupHandler = (e) => {
                if (currentMode === 'keyboard') {
                    const elementId = keyElements[e.code];
                    if (elementId) {
                        activeKeys.delete(e.code);
                        const el = document.getElementById(elementId);
                        if (el) {
                            el.style.color = '#888';
                            el.style.fontWeight = 'normal';
                        }
                    }
                }
            };

            document.addEventListener('keydown', keydownHandler);
            document.addEventListener('keyup', keyupHandler);

            // Update gamepad test display
            let testInterval = setInterval(() => {
                if (currentMode === 'gamepad') {
                    const currentGamepad = gamepadManager.getGamepad();
                    if (!currentGamepad) {
                        buttonsDiv.innerHTML = '<div style="color: #ff6666;">No gamepad connected</div>';
                        axesDiv.innerHTML = '<div style="color: #ff6666;">No gamepad connected</div>';
                        return;
                    }

                    // Update buttons
                    let buttonsHTML = '';
                    currentGamepad.buttons.forEach((button, i) => {
                        const name = buttonNames[i] || `Button ${i}`;
                        const pressed = button.pressed ? 'üü¢ PRESSED' : '‚ö´ Released';
                        const value = button.value.toFixed(2);
                        const color = button.pressed ? '#00ff00' : '#666';
                        buttonsHTML += `<div style="color: ${color};">${name.padEnd(15)} ${pressed} (${value})</div>`;
                    });
                    buttonsDiv.innerHTML = buttonsHTML;

                    // Update axes
                    let axesHTML = '';
                    const axisNames = ['Left X', 'Left Y', 'Right X', 'Right Y'];
                    currentGamepad.axes.forEach((value, i) => {
                        const name = axisNames[i] || `Axis ${i}`;
                        const bar = '‚ñà'.repeat(Math.abs(value * 10));
                        const direction = value > 0 ? '‚Üí' : value < 0 ? '‚Üê' : '¬∑';
                        axesHTML += `<div>${name.padEnd(10)} ${direction} ${bar} ${value.toFixed(3)}</div>`;
                    });
                    axesDiv.innerHTML = axesHTML;

                    // Check for Start button to close
                    if (currentGamepad.buttons[9]?.pressed) {
                        clearInterval(testInterval);
                        document.removeEventListener('keydown', keydownHandler);
                        document.removeEventListener('keyup', keyupHandler);
                        overlay.remove();
                    }
                }
            }, 50); // 20 Hz update rate

            // Close button handler
            closeBtn.addEventListener('click', () => {
                clearInterval(testInterval);
                document.removeEventListener('keydown', keydownHandler);
                document.removeEventListener('keyup', keyupHandler);
                overlay.remove();
            });

            // ESC key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    clearInterval(testInterval);
                    document.removeEventListener('keydown', keydownHandler);
                    document.removeEventListener('keyup', keyupHandler);
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }

        // Check Gamepads function - manual diagnostic
        function checkGamepads() {
            if (!navigator.getGamepads) {
                alert('‚ùå Gamepad API not supported in this browser!');
                return;
            }

            const gamepads = navigator.getGamepads();

            let foundCount = 0;
            let message = 'Gamepad Check Results:\n\n';

            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i]) {
                    foundCount++;
                    const pad = gamepads[i];
                    message += `‚úÖ Gamepad ${i}: ${pad.id}\n`;
                    message += `   Connected: ${pad.connected}\n`;
                    message += `   Buttons: ${pad.buttons.length}\n`;
                    message += `   Axes: ${pad.axes.length}\n\n`;
                }
            }

            if (foundCount === 0) {
                message += '‚ùå No gamepads detected.\n\n';
                message += 'IMPORTANT: You must press a button on your\n';
                message += 'controller before the browser can detect it.\n\n';
                message += 'Steps:\n';
                message += '1. Make sure controller is ON and connected\n';
                message += '2. Press ANY button on the controller\n';
                message += '3. Click "Check Gamepads" again\n';
            } else {
                message += `‚úÖ Found ${foundCount} gamepad(s)!`;
            }

            alert(message);
        }

        // Setup gamepad icon click handler
        document.getElementById('gamepad-icon-container').addEventListener('click', showTestController);

        // Setup book icon click handler (Species Guide)
        document.getElementById('book-icon-container').addEventListener('click', () => {
            // Create species guide overlay
            const overlay = document.createElement('div');
            overlay.id = 'species-guide-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                color: #00ff00;
                font-family: 'Courier New', monospace;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 40px;
                box-sizing: border-box;
                overflow-y: auto;
            `;

            overlay.innerHTML = `
                <div style="max-width: 900px; width: 100%;">
                    <h1 style="text-align: center; color: #00aaff; margin-bottom: 20px;">üìñ LAKE CHAMPLAIN SPECIES GUIDE</h1>
                    <div style="background: rgba(0, 50, 100, 0.3); padding: 20px; border: 2px solid #00aaff; border-radius: 10px; margin-bottom: 20px;">
                        <p style="font-size: 14px; margin: 0; text-align: center; color: #888;">
                            Your comprehensive reference for Lake Champlain species, behavior patterns, and fishing techniques
                        </p>
                    </div>

                    <div style="background: rgba(0, 100, 0, 0.2); padding: 20px; border: 2px solid #00ff00; border-radius: 10px; margin-bottom: 20px;">
                        <h2 style="color: #ffff00; margin-top: 0;">üéØ Game Species</h2>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00ff00; margin: 0 0 10px 0;">Northern Pike (Esox lucius)</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Ambush predator, prefers shallow weedy areas, active hunters</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Depth Range:</strong> 5-40 feet, often near vegetation</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Target:</strong> Aggressively chases baitfish, attracted to movement</p>
                        </div>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00ff00; margin: 0 0 10px 0;">Lake Trout (Salvelinus namaycush)</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Deep water specialist, cold-water lover, slow methodical hunter</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Depth Range:</strong> 40-150 feet, stays in thermocline</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Target:</strong> Prefers slower presentations near lake bottom</p>
                        </div>

                        <h2 style="color: #ffff00; margin-top: 30px;">üêü Baitfish</h2>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00aaff; margin: 0 0 10px 0;">Alewife</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Schools tightly when threatened, moves in coordinated patterns</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Pattern:</strong> Primary forage for all game fish</p>
                        </div>

                        <div style="margin: 15px 0; padding: 15px; background: rgba(0, 0, 0, 0.3); border-radius: 5px;">
                            <h3 style="color: #00aaff; margin: 0 0 10px 0;">Smelt</h3>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Behavior:</strong> Smaller, faster schools, often found in mid-water column</p>
                            <p style="margin: 5px 0; font-size: 12px;"><strong>Pattern:</strong> Attracts larger predators when schooling</p>
                        </div>

                        <h2 style="color: #ffff00; margin-top: 30px;">üí° Fishing Tips</h2>
                        <ul style="font-size: 12px; line-height: 1.8;">
                            <li>Watch for baitfish schools - predators follow their prey</li>
                            <li>Match your depth to where fish are actively feeding</li>
                            <li>Pike prefer faster-moving targets near structure</li>
                            <li>Lake trout hunt methodically in deeper, colder water</li>
                            <li>Adjust your jigging speed based on fish activity</li>
                        </ul>
                    </div>

                    <div style="text-align: center;">
                        <button id="close-species-guide" style="background: #ff6666; color: #000; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer;">
                            CLOSE (Press ESC)
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            const closeBtn = document.getElementById('close-species-guide');

            // Close button handler
            closeBtn.addEventListener('click', () => {
                overlay.remove();
            });

            // ESC key handler
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    overlay.remove();
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);

            // Click background to close
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        });

        // Setup camera icon click handler (Screenshot Feature)
        document.getElementById('camera-icon-container').addEventListener('click', async () => {
            try {
                // Capture screenshot FIRST (before showing any UI)
                const canvas = await html2canvas(document.body, {
                    backgroundColor: '#000000',
                    scale: 1,
                    logging: false,
                    useCORS: true
                });

                // Convert canvas to data URL
                const screenshotDataUrl = canvas.toDataURL('image/png');

                // Create screenshot modal
                const overlay = document.createElement('div');
                overlay.id = 'screenshot-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.95);
                    z-index: 10000;
                    overflow-y: auto;
                    padding: 40px;
                    box-sizing: border-box;
                `;

                overlay.innerHTML = `
                    <div style="max-width: 900px; margin: 0 auto; background: var(--panel-bg-alt); border: 2px solid var(--border-primary); border-radius: 10px; padding: 30px;">
                        <h1 style="text-align: center; color: var(--text-primary); margin: 0 0 20px 0; font-family: 'Courier New', monospace;">üì∑ Screenshot Captured</h1>

                        <div style="margin-bottom: 20px; border: 2px solid var(--border-secondary); border-radius: 5px; overflow: hidden;">
                            <img src="${screenshotDataUrl}" style="width: 100%; height: auto; display: block;" alt="Screenshot preview">
                        </div>

                        <div style="background: rgba(0, 100, 0, 0.2); padding: 20px; border: 2px solid var(--border-primary); border-radius: 10px; margin-bottom: 20px;">
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-primary); font-family: 'Courier New', monospace; font-weight: bold; margin-bottom: 5px;">
                                    Title:
                                </label>
                                <input
                                    type="text"
                                    id="screenshot-title"
                                    placeholder="Enter a title for this issue..."
                                    style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border-secondary); border-radius: 5px; color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 14px; box-sizing: border-box;"
                                >
                            </div>

                            <div style="margin-bottom: 15px;">
                                <label style="display: block; color: var(--text-primary); font-family: 'Courier New', monospace; font-weight: bold; margin-bottom: 5px;">
                                    Description:
                                </label>
                                <textarea
                                    id="screenshot-description"
                                    placeholder="Describe what you see or what issue you're reporting..."
                                    rows="6"
                                    style="width: 100%; padding: 10px; background: rgba(0, 0, 0, 0.5); border: 2px solid var(--border-secondary); border-radius: 5px; color: var(--text-primary); font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; box-sizing: border-box;"
                                ></textarea>
                            </div>
                        </div>

                        <div id="screenshot-status-message" style="display: none; padding: 15px; border-radius: 5px; margin-bottom: 20px; font-family: 'Courier New', monospace; text-align: center;"></div>

                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <button id="download-screenshot-btn" style="background: var(--button-bg); color: var(--button-text); border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer; transition: transform 0.1s;">
                                üíæ Download PNG
                            </button>
                            <button id="copy-markdown-btn" style="background: #4CAF50; color: #fff; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer; transition: transform 0.1s;">
                                üìã Copy Issue Markdown
                            </button>
                            <button id="close-screenshot-btn" style="background: #ff6666; color: #000; border: none; padding: 12px 30px; font-size: 14px; font-family: 'Courier New', monospace; font-weight: bold; border-radius: 5px; cursor: pointer; transition: transform 0.1s;">
                                ‚úñ Close (ESC)
                            </button>
                        </div>

                        <div style="margin-top: 20px; padding: 15px; background: rgba(0, 100, 200, 0.2); border: 2px solid var(--border-secondary); border-radius: 5px;">
                            <p style="margin: 0; font-size: 12px; color: #888; text-align: center; font-family: 'Courier New', monospace;">
                                ‚ÑπÔ∏è Download the screenshot as a PNG file or copy formatted markdown to create a GitHub issue manually.
                            </p>
                        </div>
                    </div>
                `;

                document.body.appendChild(overlay);

                const titleInput = document.getElementById('screenshot-title');
                const descriptionInput = document.getElementById('screenshot-description');
                const downloadBtn = document.getElementById('download-screenshot-btn');
                const copyMarkdownBtn = document.getElementById('copy-markdown-btn');
                const closeBtn = document.getElementById('close-screenshot-btn');
                const statusMessage = document.getElementById('screenshot-status-message');

                // Focus on title input
                titleInput.focus();

                // Function to show status message
                function showStatus(message, isSuccess) {
                    statusMessage.textContent = message;
                    statusMessage.style.display = 'block';
                    statusMessage.style.background = isSuccess ? 'rgba(0, 255, 0, 0.2)' : 'rgba(255, 0, 0, 0.2)';
                    statusMessage.style.border = isSuccess ? '2px solid #00ff00' : '2px solid #ff6666';
                    statusMessage.style.color = isSuccess ? '#00ff00' : '#ff6666';
                }

                // Save to localStorage
                function saveToLocalStorage() {
                    const title = titleInput.value.trim();
                    const description = descriptionInput.value.trim();

                    if (title || description) {
                        const screenshotData = {
                            title: title || 'Untitled Screenshot',
                            description: description || 'No description provided',
                            imageData: screenshotDataUrl,
                            timestamp: new Date().toISOString()
                        };
                        const existingScreenshots = JSON.parse(localStorage.getItem('wolfpack-screenshots') || '[]');
                        existingScreenshots.push(screenshotData);
                        localStorage.setItem('wolfpack-screenshots', JSON.stringify(existingScreenshots));
                    }
                }

                // Download button handler
                downloadBtn.addEventListener('click', () => {
                    const title = titleInput.value.trim() || 'wolfpack-screenshot';
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    const filename = `${title.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-${timestamp}.png`;

                    // Create download link
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = screenshotDataUrl;
                    link.click();

                    // Save to localStorage
                    saveToLocalStorage();

                    showStatus(`‚úÖ Screenshot downloaded as ${filename}`, true);
                });

                // Copy markdown button handler
                copyMarkdownBtn.addEventListener('click', async () => {
                    const title = titleInput.value.trim();
                    const description = descriptionInput.value.trim();

                    if (!title) {
                        showStatus('‚ö†Ô∏è Please enter a title first', false);
                        titleInput.focus();
                        return;
                    }

                    // Generate markdown for GitHub issue
                    const markdown = `## ${title}

${description || 'No description provided'}

### Screenshot
![Screenshot](screenshot.png)

---
**Captured:** ${new Date().toLocaleString()}
**Device:** ${navigator.userAgent}

> Note: To create this issue on GitHub:
> 1. Download the screenshot using the "Download PNG" button
> 2. Create a new issue on GitHub
> 3. Paste this markdown as the issue description
> 4. Attach the downloaded screenshot file
> 5. Add labels: \`bug\`, \`screenshot\``;

                    try {
                        await navigator.clipboard.writeText(markdown);
                        showStatus('‚úÖ Issue markdown copied to clipboard!', true);

                        // Save to localStorage
                        saveToLocalStorage();
                    } catch (error) {
                        console.error('Failed to copy to clipboard:', error);
                        showStatus('‚ö†Ô∏è Failed to copy to clipboard. Please try again.', false);
                    }
                });

                // Close button handler
                closeBtn.addEventListener('click', () => {
                    overlay.remove();
                });

                // ESC key handler
                const escHandler = (e) => {
                    if (e.key === 'Escape') {
                        overlay.remove();
                        document.removeEventListener('keydown', escHandler);
                    }
                };
                document.addEventListener('keydown', escHandler);

                // Click background to close
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.remove();
                    }
                });

                // Clean up event listener when overlay is removed
                overlay.addEventListener('remove', () => {
                    document.removeEventListener('keydown', escHandler);
                });

            } catch (error) {
                console.error('Screenshot capture failed:', error);
                alert('Failed to capture screenshot. Please try again.');
            }
        });

    </script>

    <!-- Commit Log Modal -->
    <div id="commit-log-modal" style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10000;
        overflow-y: auto;
    ">
        <div style="
            max-width: 900px;
            margin: 40px auto;
            background: var(--bg-primary);
            border: 2px solid var(--border-primary);
            border-radius: 8px;
            padding: 20px;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--text-primary); margin: 0; font-family: 'Courier New', monospace;">
                    üìú Git Commit History
                </h2>
                <button id="close-commit-log" style="
                    background: var(--bg-danger);
                    color: white;
                    border: none;
                    padding: 8px 16px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-family: 'Courier New', monospace;
                    font-size: 14px;
                ">Close</button>
            </div>
            <div id="commit-log-content" style="
                font-family: 'Courier New', monospace;
                font-size: 11px;
                color: var(--text-muted);
                white-space: pre-wrap;
                max-height: 70vh;
                overflow-y: auto;
                background: rgba(0, 0, 0, 0.3);
                padding: 15px;
                border-radius: 4px;
                border: 1px solid var(--border-secondary);
                line-height: 1.6;
            ">
                Loading commit history...
            </div>
        </div>
    </div>

    <!-- Version Display and Commit Log Script -->
    <script type="module">
        // Fetch version info from a generated version.json file
        async function loadVersionInfo() {
            try {
                const response = await fetch('/version.json');
                const data = await response.json();

                const versionEl = document.getElementById('version-hash');
                if (versionEl) {
                    versionEl.textContent = `v${data.version} (${data.commit})`;
                }
            } catch (error) {
                console.warn('Could not load version info:', error);
                const versionEl = document.getElementById('version-hash');
                if (versionEl) {
                    versionEl.textContent = 'dev';
                }
            }
        }

        // Fetch commit log
        async function loadCommitLog() {
            try {
                const response = await fetch('/commits.txt');
                const data = await response.text();

                const contentEl = document.getElementById('commit-log-content');
                if (contentEl && data) {
                    contentEl.textContent = data;
                } else {
                    contentEl.textContent = 'Could not load commit history.';
                }
            } catch (error) {
                console.error('Could not load commit log:', error);
                const contentEl = document.getElementById('commit-log-content');
                if (contentEl) {
                    contentEl.textContent = 'Error loading commit history.\n\nThis feature requires the commits.txt file to be generated during deployment.';
                }
            }
        }

        // Setup version display click handler
        const versionDisplay = document.getElementById('version-display');
        const commitLogModal = document.getElementById('commit-log-modal');
        const closeButton = document.getElementById('close-commit-log');

        if (versionDisplay) {
            // Hover effect
            versionDisplay.addEventListener('mouseenter', () => {
                versionDisplay.style.color = '#00ff00';
                versionDisplay.style.borderColor = '#00ff00';
            });
            versionDisplay.addEventListener('mouseleave', () => {
                versionDisplay.style.color = '#888888';
                versionDisplay.style.borderColor = '#444444';
            });

            // Click to show commit log
            versionDisplay.addEventListener('click', () => {
                commitLogModal.style.display = 'block';
                loadCommitLog();
            });
        }

        if (closeButton) {
            closeButton.addEventListener('click', () => {
                commitLogModal.style.display = 'none';
            });
        }

        // Close modal on escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && commitLogModal.style.display === 'block') {
                commitLogModal.style.display = 'none';
            }
        });

        // Close modal on background click
        commitLogModal.addEventListener('click', (e) => {
            if (e.target === commitLogModal) {
                commitLogModal.style.display = 'none';
            }
        });

        // Load version on page load
        loadVersionInfo();
    </script>
</body>
</html>
